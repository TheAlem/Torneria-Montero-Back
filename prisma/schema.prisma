// Prisma schema actualizado para Torner√≠a Montero

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ========================
   ENUMS
   ======================== */
enum Priority {
  BAJA
  MEDIA
  ALTA
}

enum PaymentStatus {
  PENDIENTE
  PAGADO
  FALLIDO
  REEMBOLSADO
}

enum JobStatus {
  PENDIENTE
  EN_PROCESO
  TERMINADO
  ENTREGADO
}

enum PaymentMethod {
  QR
  EFECTIVO
  TRANSFERENCIA
}

enum UserRole {
  ADMIN
  TORNERO
  CLIENTE
}

/* ========================
   MODELOS
   ======================== */

model Client {
  id        String   @id @default(uuid())
  name      String
  company   String?
  phone     String
  email     String?  @unique
  address   String?
  jobs      Job[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone], name: "idx_clients_phone")
  @@index([email], name: "idx_clients_email")
}

model User {
  id        String   @id @default(uuid())
  fullName  String
  password  String
  email     String?  @unique
  phone     String?
  role      UserRole @default(CLIENTE)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  jobStatusChanges JobStatusHistory[]
}

model Worker {
  id        String   @id @default(uuid())
  fullName  String
  specialty String?
  phone     String?
  active    Boolean  @default(true)
  jobs      Job[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Job {
  id                String        @id @default(uuid())
  code              String        @unique
  title             String
  description       String
  clientId          String
  client            Client        @relation(fields: [clientId], references: [id])
  assignedWorkerId  String
  assignedWorker    Worker        @relation(fields: [assignedWorkerId], references: [id])
  priority          Priority      @default(MEDIA)
  status            JobStatus     @default(PENDIENTE)
  estimatedHours    Float?
  estimatedDelivery DateTime?
  price             Decimal       @db.Decimal(12, 2)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relaciones
  statusHistory JobStatusHistory[]
  payments      Payment[]
  transaction   GatewayTransaction?

  @@index([status, priority, estimatedDelivery], name: "idx_job_kanban_main")
  @@index([updatedAt], name: "idx_job_updated_at")
}

model JobStatusHistory {
  id         String   @id @default(uuid())
  jobId      String
  job        Job      @relation(fields: [jobId], references: [id])
  oldStatus  JobStatus?
  newStatus  JobStatus
  changedById String?
  changedBy   User?    @relation(fields: [changedById], references: [id])
  changedAt  DateTime @default(now())
}

model Payment {
  id          String        @id @default(uuid())
  jobId       String
  job         Job           @relation(fields: [jobId], references: [id])
  amount      Decimal       @db.Decimal(12, 2)
  method      PaymentMethod
  status      PaymentStatus @default(PENDIENTE)
  createdAt   DateTime      @default(now())
}

model GatewayTransaction {
  id          String        @id @default(uuid())
  jobId       String        @unique
  job         Job           @relation(fields: [jobId], references: [id])
  provider    String
  externalId  String        @unique
  qrUrl       String
  amount      Decimal       @db.Decimal(12, 2)
  status      PaymentStatus @default(PENDIENTE)
  payload     Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}